---
title: "NY Hospital Merger Trends"
date: "`r format(Sys.time(), '%B %Y')`"
output: pdf_document
header-inlcudes:
    - usepackage{amsmath}
---


```{r rmd_setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(include=TRUE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60), tidy=TRUE)
knitr::opts_knit$set(root.dir='..')
```

```{r libraries, include=FALSE}
library(haven)
library(tidyverse)
library(knitr)
library(kableExtra)

theme_set(theme_bw())
```

```{r setup, include=FALSE}
tables <- read_dta("dump/merger_trends.dta")
```

Figures and tables represent data from the AHA:  

    - years: 2006-2012  
    - all hospitals  

# Hospital-level trends

```{r, include=TRUE}
tables %>% filter(table=='A') %>%
ggplot(aes(aha_year, proportion, linetype=factor(ny))) +
    geom_line() +
    scale_linetype_manual('', breaks=c('1', '0'), labels=c('1'='New York', '0'='Other states'), values=c('1'=1, '0'=2)) +
    scale_x_continuous(breaks=seq(2006,2012,2)) +
    labs(x='Year', y='Proportion', title='Share of hospitals that experienced merger activity')
```

```{r, include=TRUE}
tables %>%
    filter(table=='A') %>%
    mutate(State=ifelse(ny==1,'New York','Other states')) %>%
    select(aha_year, State, proportion, total_hospitals) %>%
    unite(val, proportion, total_hospitals, sep='-') %>%
    spread(State, val) %>%
    separate(`New York`, c('nshare', 'nhosps'), sep='-') %>%
    separate(`Other states`, c('oshare', 'ohosps'), sep='-') %>%
    mutate(nshare=substr(nshare,1,5), oshare=substr(oshare,1,5)) %>%
    kable(caption='Share of hospitals that experienced merger activity', col.names=c('Year', 'Prop.', 'Hospitals', 'Prop.', 'Hospitals'), align='lcccc', format='latex', booktabs=TRUE) %>%
    add_header_above(header=c('', 'New York'=2, 'Other states'=2)) %>%
    kable_styling(latex_options=c('hold_position', 'striped'))
```


# Market-level trends

```{r, include=FALSE}
temp <- tables %>%
    filter(table=='B') %>%
    mutate(val=paste0(round(mean,2), ' (', round(sd,2), ')'),
        State=ifelse(ny==1,'New York','Other states'),
        metric=paste0(metric, ' ', type)) %>%
    select(State, metric, val) %>%
    spread(State, val) %>%
    mutate(metric=trimws(Hmisc::capitalize(metric))) %>%
    mutate(metric=case_when(grepl('forprof$', metric)~'Ownership: For-profit',
        grepl('nonprof$', metric)~'Ownership: Non-profit',
        grepl('govfed$',metric)~'Ownership: Gov., federal',
        grepl('govnfed$', metric)~'Ownership: Gov., non-federal',
        TRUE~metric)) %>%
    mutate(metric=factor(metric, levels=c('Mergers', 'Closures', 'Openings', 'Hospitals', 'Beds', 'Ownership: For-profit', 'Ownership: Non-profit', 'Ownership: Gov., federal', 'Ownership: Gov., non-federal'), ordered=TRUE)) %>%
    arrange(metric)
```

```{r, include=TRUE}
temp %>%
    kable(caption='Market-level averages', col.names=c('', 'New York', 'Other states'), align='lcc', format='latex', booktabs=TRUE) %>%
    kable_styling(latex_options=c('hold_position', 'striped'))
```
