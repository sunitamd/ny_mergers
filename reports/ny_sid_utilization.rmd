---
title: "NY HUCP Utilization Services Summary"
date: "`r format(Sys.time(), '%B %d %Y')`"
output: pdf_document
header-inlcudes:
    - usepackage{amsmath}
    - usepackage[document]{ragged2e}
    - usepackage{float}
urlcolor: red
---


```{r rmd_setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)
knitr::opts_chunk$set(include=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=80), tidy=TRUE)
knitr::opts_knit$set(root.dir='..')
```
```{r libraries}
library(haven)
library(tidyverse)
library(knitr)
library(kableExtra)
library(RColorBrewer)
```

```{r plot settings}
theme_set(theme_bw())
```

```{r functions}
printKable <- function(tbl_data, caption='') {
	# Print kable of utilization x payer data

		kable(tbl_temp, digits=2, caption=paste0('Payer types by service utilization, ', year), col.names=names(tbl_temp), format='latex', booktabs=TRUE, longtable=TRUE) %>%
		kable_styling(latex_options=c('hold_position', 'striped', 'repeat_header'))
		
}
```

```{r data}
# Utilization by payer type
dat_pay <- read_dta('dump/ny_sid_supp_pay.dta')
# Payer type by utilization services
dat_util <- read_dta('dump/ny_sid_supp_util.dta')
# Utilization by household income quartiles
dat_inc <- read_dta('dump/ny_sid_supp_inc.dta')
```

# Tables

## Share of service utilization by payer type

- *Note:* Years broken into 3 tables, rows sum to 1.0 across 3 tables

```{r prep pay}
vars <- names(dat_pay)[grep('_pc$', names(dat_pay))]

temp_pay <- dat_pay %>%
	mutate(
		payer=case_when(
			pay1==1 ~ 'Medicare',
			pay1==2 ~ 'Medicaid',
			pay1==3 ~ 'Private ins.',
			pay1==4 ~ 'Self-pay',
			pay1==5 ~ 'No charge',
			pay1==6 ~ 'Other'),
		) %>%
	arrange(year, pay1) %>%
	select(year, payer, !!vars)

years <- 2006:2012
# Format each year into separate table
pay_years <- lapply(years, function(y, .data=temp_pay, .vars=vars) {
	.temp <- .data %>%
		filter(year==!!y) %>%
		select(payer, !!.vars) %>%
		t()

	# Grep col & row names
	payer_types <- .temp[1,]
	services <- sub('_pc$', '', row.names(.temp[-1,]))
	# Cast to tibble
	.temp <- .temp[-1,] %>% as_tibble(rownames=NA)
	# Set col names
	names(.temp) <- payer_types
	# Convert percentages to numeric
	.temp <- mutate_all(.temp, .funs=as.numeric)
	# Add utilization services
	.temp <- mutate(.temp, service=!!services) %>%
		select(service, everything())

	return(.temp)
})
names(pay_years) <- years
```

```{r print pay, include=TRUE, results='asis'}
for (year in years) {
	tbl_temp <- pay_years[[!!year]]
	
	print(kable(tbl_temp, digits=2, caption=paste0('Service utilization by payer type, ', year), col.names=names(tbl_temp), format='latex', booktabs=TRUE) %>%
		kable_styling(latex_options=c('HOLD_position', 'striped'))
		)
}
```


## Share of payer types by service utilization

- *Note:* rows sum to 1.0

```{r prep util}
vars <- names(dat_util)[grep('_pc$', names(dat_util))]

temp_util <- dat_util %>%
	arrange(year, service_id) %>%
	select(year, service, !!vars)

years <- 2006:2012
# Format each year into separate table
util_years <- lapply(years, function(y, .data=temp_util, .vars=vars) {
	.temp <- .data %>%
		filter(year==!!y) %>%
		select(service, !!.vars) %>%
		t()

	# Grep col & row names
	services <- .temp[1,]
	payer_types <- sub('_pc$', '', row.names(.temp[-1,]))
	# Cast to tibble
	.temp <- .temp[-1,] %>% as_tibble(rownames=NA)
	# Set col names
	names(.temp) <- services
	# Convert percentages to numeric
	.temp <- mutate_all(.temp, .funs=as.numeric)
	# Add utilization services
	.temp <- mutate(.temp, payer=!!payer_types) %>%
		mutate(payer=case_when(
			payer=='pay_1' ~ 'Medicare',
			payer=='pay_2' ~ 'Medicaid',
			payer=='pay_3' ~ 'Private ins.',
			payer=='pay_4' ~ 'Self-pay',
			payer=='pay_5' ~ 'No charge',
			payer=='pay_6' ~ 'Other')) %>%
		select(payer, everything())

	return(.temp)
})
names(util_years) <- years
```

```{r print util, include=TRUE, results='asis'}
for (year in years) {
	tbl_temp <- util_years[[!!year]]
	tbl_temp1 <- tbl_temp[, c(1:11)]
	tbl_temp2 <- tbl_temp[, c(1,12:21)]
	tbl_temp3 <- tbl_temp[, c(1,22:31)]
	
	print(kable(tbl_temp1, digits=2, caption=paste0('Payer types by service utilization, ', year, ' (1/3)'), col.names=names(tbl_temp1), format='latex', booktabs=TRUE) %>%
		kable_styling(latex_options=c('HOLD_position', 'striped')) %>%
		row_spec(0, angle=-45)
		)
	print(kable(tbl_temp2, digits=2, caption=paste0('Payer types by service utilization, ', year, ' (2/3)'), col.names=names(tbl_temp2), format='latex', booktabs=TRUE) %>%
		kable_styling(latex_options=c('HOLD_position', 'striped')) %>%
		row_spec(0, angle=-45)
		)
	print(kable(tbl_temp3, digits=2, caption=paste0('Payer types by service utilization, ', year, ' (3/3)'), col.names=names(tbl_temp2), format='latex', booktabs=TRUE) %>%
		kable_styling(latex_options=c('HOLD_position', 'striped')) %>%
		row_spec(0, angle=-45)
		)
}
```

## Share of service utilization by estimated median household income of residents in the patient's ZIP Code

- *Note:* rows sum to 1.00.
Dollar amounts for quartiles change annually, see [here](https://www.hcup-us.ahrq.gov/db/vars/siddistnote.jsp?var=zipinc_qrtl)

```{r prep inc}
vars <- names(dat_inc)[grep('_pc$', names(dat_inc))]

temp_inc <- dat_inc %>%
	mutate(zipinc_qrtl=case_when(
		is.na(zipinc_qrtl) ~ 'Missing',
		TRUE ~ paste0('Qrtl ', zipinc_qrtl))) %>%
	arrange(year, zipinc_qrtl) %>%
	select(year, zipinc_qrtl, !!vars)

years <- 2006:2012
# Format each year into separate table
inc_years <- lapply(years, function(y, .data=temp_inc, .vars=vars) {
	.temp <- .data %>%
		filter(year==!!y) %>%
		select(zipinc_qrtl, !!.vars) %>%
		t()

	# Grep col & row names
	inc_qrtls <- .temp[1,]
	services <- sub('_pc$', '', row.names(.temp[-1,]))
	# Cast to tibble
	.temp <- .temp[-1,] %>% as_tibble(rownames=NA)
	# Set col names
	names(.temp) <- inc_qrtls
	# Convert percentages to numeric
	.temp <- mutate_all(.temp, .funs=as.numeric)
	# Add utilization services
	.temp <- mutate(.temp, service=!!services) %>%
		select(service, everything()) %>%
		select(-Missing, everything())

	return(.temp)
})
names(inc_years) <- years
```

```{r print inc, include=TRUE, results='asis'}
for (year in years) {
	tbl_temp <- inc_years[[!!year]]
	
	print(kable(tbl_temp, digits=2, caption=paste0('Service utilization by est. median zipcode income quartile, ', year), col.names=names(tbl_temp), format='latex', booktabs=TRUE) %>%
		kable_styling(latex_options=c('HOLD_position', 'striped'))
		)
}
```


# Heatmaps

## Share of service utilization by payer types

```{r}
temp <- pay_years$`2011` %>%
	gather(payer, share, Medicare:Other)


ggplot(temp, aes(payer, service)) +
	geom_tile(aes(fill=share))
```


## Share of payer types by service utilization


## Share of service utilization by estimated median household income of residents in the patient's ZIP Code